---
title: "tennis"
author: "Mihai Matei, Catalin Stefan Cernat 511DS"
date: "3/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## ATP Tennis Visualisation

This project is about tennis ATP results

```{r, echo=FALSE}
load_packages <- function(package_names) {
  list.of.packages <- as.vector(package_names)
  new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
  if(length(new.packages)) {
    install.packages(new.packages)
  }
  sapply(list.of.packages, require, character.only = TRUE)
}

load_packages(c('rmarkdown', 'tidyverse', 'lubridate', 'reshape2'))
```

### Merging ATP and WTA matches CVS files

```{r, echo=FALSE}
load_data <- function(directory, regex, column_types, col_names=TRUE) {
  list.files(path = directory, pattern = regex, full.names = T) %>%
    lapply( (function (file) read_csv(file, col_types = column_types, col_names = col_names)) ) %>% dplyr::bind_rows()
}

column_types <- cols(
  best_of = 'c',        # Parsed later (factor)
  round = 'c',          # Parsed later (factor)
  tourney_id = 'c',     # Parsed later (factor)
  tourney_name = 'c',   # Parsed later (factor)
  tourney_level = 'c',  # Parsed later (factor)
  surface = 'c',        # Parsed later (factor)
  winner_entry = 'c',   # Parsed later (factor)
  winner_name = 'c',    # Parsed later (factor)
  winner_hand = 'c',    # Parsed later (factor)
  winner_ioc = 'c',     # Parsed later (factor)
  loser_entry = 'c',    # Parsed later (factor)
  loser_name = 'c',     # Parsed later (factor)
  loser_hand = 'c',     # Parsed later (factor)
  loser_ioc = 'c',      # Parsed later (factor)
  winner_id = 'c',      # Parsed later (factor)
  loser_id = 'c',       # Parsed later (factor)
  
  winner_age = 'd',
  loser_age = 'd',
  
  draw_size = 'c',      # Parsed later (some non numeric in WTA)
  tourney_date = 'c',   # Parsed later (needs to specify format)
  match_num = 'i',
  winner_seed = 'c',    # Parsed later (some non numeric in WTA)
  winner_ht = 'i',
  loser_seed = 'c',     # Parsed later (some non numeric in WTA)
  loser_ht = 'i',
  minutes = 'i',
  w_ace = 'i',
  w_df = 'i',
  w_svpt = 'i',
  w_1stIn = 'i',
  w_1stWon = 'i',
  w_2ndWon = 'i',
  w_SvGms = 'i',
  w_bpSaved = 'i',
  w_bpFaced = 'i',
  l_ace = 'i',
  l_df = 'i',
  l_svpt = 'i',
  l_1stIn = 'i',
  l_1stWon = 'i',
  l_2ndWon = 'i',
  l_SvGms = 'i',
  l_bpSaved = 'i',
  l_bpFaced = 'i',
  winner_rank = "i",
  winner_rank_points = 'i',
  loser_rank = "i",
  loser_rank_points = 'i'
)

#setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

singles_atp_DF <- load_data('./data/tennis_atp', "atp_matches_\\d*.csv", column_types)
singles_wta_DF <- load_data('./data/tennis_wta', "wta_matches_\\d*.csv", column_types)

combined_DF <- bind_rows(list(ATP = singles_atp_DF, WTA = singles_wta_DF), .id = "league") %>%
  separate(col = tourney_id, into=c("year", "tourney_id"), sep="-", extra="merge") %>%
  mutate(league = factor(league),
         best_of = factor(best_of, ordered = TRUE, levels = c("3", "5")),
         round = factor(round, ordered = TRUE, levels = c("Q4", "ER", "BR", "RR", "R128", "R64", "R32", "R16", "QF", "SF", "F")),
         
         tourney_name = factor(tourney_name),
         tourney_level = factor(tourney_level),
         surface = factor(surface),
         winner_entry = factor(winner_entry),
         winner_name = factor(winner_name),
         winner_hand = factor(winner_hand),
         winner_ioc = factor(winner_ioc),
         loser_entry = factor(loser_entry),
         loser_name = factor(loser_name),
         loser_hand = factor(loser_hand),
         loser_ioc = factor(loser_ioc),
         winner_id = factor(winner_id),
         loser_id = factor(loser_id),
         
         tourney_id = factor(tourney_id),
         year = as.integer(year),
         tourney_date = parse_date(tourney_date, format="%Y%m%d"),
         
         draw_size = suppressWarnings(as.numeric(draw_size)),
         winner_seed = suppressWarnings(as.numeric(winner_seed)),
         loser_seed = suppressWarnings(as.numeric(loser_seed)),
         
         w_1stPercWon = (w_1stWon / w_1stIn),
         l_1stPercWon = (l_1stWon / l_1stIn),
         w_breaks = (l_bpFaced - l_bpSaved),
         l_breaks = (w_bpFaced - l_bpSaved)
         )


#nrow(combined_DF)
#ncol(combined_DF)
#sapply(combined_DF, class)

#doublesDF <- load_data('./data/tennis_atp', "atp_matches_doubles_\\d*.csv",
#                       cols( winner_entry = "c", loser_entry="c"))
```

### Merging ATP and WTA player CSV files 

```{r, echo=FALSE}
col_names <- c(
  "player_id", "first_name", "last_name", "hand", "birth_date", "ioc"
)

column_types <- cols(
  player_id = "c",  # Parsed later (factor)
  first_name = "c",
  last_name = "c",
  hand = "c",       # Parsed later (factor)
  birth_date = "c", # Parsed later (needs to specify format)     
  ioc = "c"         # Parsed later (factor)
)


players_atp_DF <- load_data('./data/tennis_atp', "atp_players.csv", column_types, col_names)
players_wta_DF <- load_data('./data/tennis_wta', "wta_players.csv", column_types, col_names)

players_DF <- bind_rows(list(ATP = players_atp_DF, WTA = players_wta_DF), .id = "league") %>%
  mutate(
    league = factor(league),
    player_id = factor(player_id),
    hand = factor(hand),
    birth_date = suppressWarnings(parse_date(birth_date, format="%Y%m%d")),
    ioc = factor(ioc))
```

### Merging ATP and WTA rankings CSV files

```{r, echo=FALSE}
col_names <- c("ranking_date", "rank", "player", "points")
column_types <- cols(
  ranking_date = "c", # Parsed later (needs to specify format)
  rank = "i",
  player = "c",       # Parsed later (factor)
  points = "i"
)


rankings_atp_DF <- load_data('./data/tennis_atp', "atp_rankings_(70|80|90|00|10)s.csv", column_types) %>%
  bind_rows(load_data('./data/tennis_atp', "atp_rankings_(20)s.csv", column_types, col_names))


col_names <- c("ranking_date", "rank", "player", "points", "undefined")
column_types <- cols(
  ranking_date = "c", # Parsed later (needs to specify format)
  rank = "i",
  player = "c",       # Parsed later (factor)
  points = "i",
  undefined = "c"     # Extra column
)

rankings_wta_DF <- load_data('./data/tennis_wta', "wta_rankings_(80|90|00|20)s.csv", column_types, col_names) %>%
  bind_rows(load_data('./data/tennis_wta', "wta_rankings_(10)s.csv", column_types)) %>%
  select(c("ranking_date", "rank", "player", "points"))


rankings_DF <- bind_rows(list(ATP = rankings_atp_DF, WTA = rankings_wta_DF), .id = "league") %>%
  mutate(
    league = factor(league),
    ranking_date = parse_date(ranking_date, format="%Y%m%d"),
    player = factor(player))
```

### EDA

#### Number of matches per year
Visualize how the number of matcher per league evoluted along each year. Notice the impact of the coronavirul pandemy.

```{r, echo=FALSE}
ggplot(combined_DF %>% group_by(league, year) %>% summarise(no_matches = length(year), .groups = 'drop'),
       aes(x=year, y=no_matches, group=league)) +
  scale_x_continuous(breaks=seq(1848, 2021, 5)) +
  geom_line(aes(color=league), size=1) + 
  scale_color_manual(values=c('blue','red')) +
  labs(x="Year", y="Number of matches", title="Number of matches per year") +
  geom_vline(xintercept=2020, linetype="dotted", color="black", size=0.7) +
  geom_text(aes(x=2020, label="CORONAVIRUS", y=3500), angle=90) +
  theme_classic()
```

#### Player hand statistics

Visualize how many players in both leagues use left, right or both hands for backhand

```{r, echo=FALSE}
ggplot(combined_DF %>% filter(!is.na(winner_hand)) %>% group_by(league, winner_id, winner_hand) %>% distinct(winner_id)) +
  geom_bar(aes(winner_hand, fill = league), position = "dodge") +
  scale_fill_manual(values=c('blue','red')) +
  labs(x="Player hand", y="Number of players", title="Bar plot for number of players by hand") +
  theme_classic()
```

Visualize how many matches are played per league depending on backhand
```{r, echo=FALSE}
ggplot(combined_DF %>% filter(!is.na(winner_hand) & !is.na(loser_hand)) %>%
         group_by(league, winner_hand, loser_hand) %>% summarise(no_matches = length(winner_hand), .groups = 'drop'),
       aes(winner_hand, loser_hand)) +
  geom_tile(aes(fill=no_matches)) +
  scale_fill_gradient(low = "light gray", high = "blue") +
  labs(x="Winner hand", y="Loser hand", title="Tile plot for number of matches by backhand") +
  theme_classic() +
  facet_wrap(~league, nrow=1)
```

#### Round statistics

Visualize the average match length by round type
```{r, echo=FALSE}

# Get lower and upper whiskers
ylim <- boxplot.stats((combined_DF %>% filter(!is.na(minutes)))$minutes)$stats[c(1, 5)]

ggplot(combined_DF %>% filter(!is.na(minutes)) %>% group_by(league, round) %>%
         filter(round != "BR", round != "ER", round != "Q4"),
       aes(round, minutes)) +
  geom_boxplot(aes(fill=league), outlier.shape = NA) +
  coord_cartesian(ylim = ylim * 1.5) +
  labs(x="Winner hand", y="Loser hand", title="Box plot for match duration by round")
```


#### Rank difference

Visualize the average rank by player age
```{r, echo=FALSE}

ggplot(players_DF %>% select(league, player_id, birth_date) %>%
         inner_join(rankings_DF %>% select(league, player, ranking_date, rank), by = (c("league" = "league", "player_id" = "player"))) %>%
         mutate(age = floor(time_length(difftime(ranking_date, birth_date), "years"))) %>%
         filter(age > 10, age < 60) %>%
         group_by(league, age) %>% summarise(avg_rank = mean(rank)),
       aes(age, avg_rank)) +
  geom_line(aes(color=league)) +
  scale_x_continuous(breaks=seq(10, 60, 5)) +
  scale_y_reverse() +
  labs(x="Player Age", y="Average rank", title="Average Rank by Age")
```

Visualize the average rank by player age (only looking at top 20)
```{r, echo=FALSE}

ggplot(players_DF %>% select(league, player_id, birth_date) %>%
         inner_join(rankings_DF %>% select(league, player, ranking_date, rank), by = (c("league" = "league", "player_id" = "player"))) %>%
         mutate(age = floor(time_length(difftime(ranking_date, birth_date), "years"))) %>%
         filter(age > 10, age < 60, rank < 20) %>%
         group_by(league, age) %>% summarise(avg_rank = mean(rank)),
       aes(age, avg_rank)) +
  geom_line(aes(color=league)) +
  scale_x_continuous(breaks=seq(10, 60, 5)) +
  scale_y_reverse() +
  labs(x="Player Age", y="Average rank", title="Average Rank by Age (Top 20)")
```

Visualize the distribution of rank difference of players in matches. Notice is gaussian with 0 mean.
```{r, echo=FALSE}
ggplot(combined_DF %>% filter(!is.na(winner_rank) & !is.na(loser_rank)) %>% 
         group_by(league, winner_rank, loser_rank) %>% summarise(rank_difference = winner_rank - loser_rank, .groups = 'drop'),
       aes(x=rank_difference)) +
  geom_freqpoly(aes(color=league), bins=100) +
  scale_color_manual(values=c('blue','red')) +
  labs(x="Winner rank difference", y="Number of matches", title="Player rank difference of played matches") +
  theme_classic()
```



#### Serve statistics

Visualize the percentage of serves won if 1st serve is inside the court (How strong players 1st serve is)
```{r, echo=FALSE}
ggplot(combined_DF %>% select(league, w_1stPercWon) %>% rename(perc_won = w_1stPercWon) %>%
         bind_rows(combined_DF %>% select(league, l_1stPercWon) %>% rename(perc_won = l_1stPercWon)) %>%
         filter(!is.na(perc_won)),
       aes(perc_won, group=league, fill=league)) +
  geom_density() +
  facet_wrap(~league) +
  labs(x="Percentage won", y="Density", title="Percentage of 1st serves won (if serve is in)")
```

Correlation between serves and breaks with match wins
```{r, echo=FALSE}
serves_correlation <- cor(
  combined_DF %>%
    select(w_1stIn, w_1stWon, w_2ndWon, w_breaks) %>%
    filter(!is.na(w_1stIn), !is.na(w_1stWon), !is.na(w_2ndWon), !is.na(w_breaks)) %>%
    rename(fstIn = w_1stIn, fstWon = w_1stWon, sndWon = w_2ndWon, breaks = w_breaks) %>% mutate(win = 1) %>%
    bind_rows(combined_DF %>%
                select(l_1stIn, l_1stWon, l_2ndWon, l_breaks) %>%
                filter(!is.na(l_1stIn), !is.na(l_1stWon), !is.na(l_2ndWon), !is.na(l_breaks)) %>%
                rename(fstIn = l_1stIn, fstWon = l_1stWon, sndWon = l_2ndWon, breaks = l_breaks) %>% mutate(win = 0))
)

ggplot(data = melt(serves_correlation), aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile() +
  scale_fill_viridis_c() +
  labs(x="Variable 1", y="Variable 2", title="Correlation Matrix for serves and breaks")
```
